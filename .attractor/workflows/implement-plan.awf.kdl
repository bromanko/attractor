workflow "Implement Plan" {
  version 2
  description "Implement an existing plan with code reviews and CI checks"
  start "ws_create"

  stage "ws_create" kind="workspace.create" workspace_name="implement-plan"

  stage "implement" kind="llm" model="claude-opus-4-6" provider="anthropic" goal_gate=true prompt="Read the project and implement the matching plan from ./docs/plans/ for goal: $goal. Follow project patterns and add tests."

  stage "selfci" kind="tool" command="CANDIDATE=$(jj log -r 'latest(heads(::@ ~ empty()))' --no-graph -T 'commit_id.short()' --limit 1) && nix develop -c selfci check --candidate $CANDIDATE"

  stage "review_code" kind="llm" model="claude-opus-4-6" provider="anthropic" auto_status=true prompt_file=".pi/skills/attractor-typescript-code-review/SKILL.md,.attractor/prompts/review-status-markers.md"
  stage "review_security" kind="llm" model="claude-opus-4-6" provider="anthropic" auto_status=true prompt_file=".pi/skills/attractor-typescript-security-review/SKILL.md,.attractor/prompts/review-status-markers.md"
  stage "review_perf" kind="llm" model="claude-opus-4-6" provider="anthropic" auto_status=true prompt_file=".pi/skills/attractor-typescript-performance-review/SKILL.md,.attractor/prompts/review-status-markers.md"
  stage "review_tests" kind="llm" model="claude-opus-4-6" provider="anthropic" auto_status=true prompt_file=".pi/skills/attractor-typescript-test-review/SKILL.md,.attractor/prompts/review-status-markers.md"

  stage "gate" kind="decision" {
    route when="outcome(\"review_code\") != \"success\" || outcome(\"review_security\") != \"success\" || outcome(\"review_perf\") != \"success\" || outcome(\"review_tests\") != \"success\" || outcome(\"selfci\") != \"success\"" to="fix"
    route when="true" to="human_review"
  }

  stage "fix" kind="llm" model="claude-opus-4-6" provider="anthropic" prompt="Fix all outstanding issues from the review findings and CI failures.\n\n- **HIGH and MEDIUM findings:** Fix every one of these. They are mandatory.\n- **LOW findings:** Use your judgement â€” fix those that are quick wins or clearly improve the code, skip those that are cosmetic or debatable.\n\nCommit your fixes incrementally." {
    retry max_attempts=3 backoff="exponential"
  }

  stage "human_review" kind="human" {
    prompt "All automated checks passed. Review implementation."
    option "approve" label="Approve" to="ws_merge"
    option "revise" label="Revise" to="revise"
  }

  stage "revise" kind="llm" model="claude-opus-4-6" provider="anthropic" prompt="Apply human feedback from human.gate.feedback and commit changes." {
    retry max_attempts=3 backoff="exponential"
  }

  stage "ws_merge" kind="workspace.merge"
  stage "ws_cleanup" kind="workspace.cleanup"
  stage "exit" kind="exit"

  transition from="ws_create" to="implement"
  transition from="implement" to="selfci"
  transition from="selfci" to="review_code" when="outcome(\"selfci\") == \"success\""
  transition from="selfci" to="fix" when="outcome(\"selfci\") != \"success\""
  transition from="review_code" to="review_security"
  transition from="review_security" to="review_perf"
  transition from="review_perf" to="review_tests"
  transition from="review_tests" to="gate"
  transition from="fix" to="selfci"
  transition from="revise" to="selfci"
  transition from="ws_merge" to="ws_cleanup"
  transition from="ws_cleanup" to="exit"
}

workflow "QuickDev" {
  version 2
  goal "(specify with --goal)"
  start "plan"

  stage "plan" kind="llm" model="gpt-5.3-codex" provider="openai-codex" prompt="You are working on an existing TypeScript project.\nRead the project structure, README, existing code, and tests to understand the codebase thoroughly.\n\nThen create a detailed implementation plan for the goal.\n\nGoal: $goal\n\nYour plan should include:\n1. Summary\n2. Files to change\n3. Approach\n4. Edge cases\n5. Test cases\n6. Open questions\n\nOutput a concise structured plan. Do NOT write the plan to a file — keep it in your response only."

  stage "plan_review" kind="llm" model="gpt-5.3-codex" provider="openai-codex" auto_status=true prompt="You are a senior engineer reviewing an implementation plan.\n\nIf the plan is sound enough to implement, output [STATUS: success].\nIf there are serious gaps, output [STATUS: fail] with [FAILURE_REASON: ...]."

  stage "human_review" kind="human" {
    prompt "Review the plan and the LLM critique. Approve to implement or revise."
    option "approve" label="Approve" to="implement"
    option "revise" label="Revise" to="plan_revise"
    meta {
      review_markdown_keys "plan._full_response,plan_review._full_response"
    }
  }

  stage "plan_revise" kind="llm" model="gpt-5.3-codex" provider="openai-codex" response_key_base="plan" prompt="Revise the plan based on human.gate.feedback and plan_review.response. Output the complete revised plan. Do NOT write the plan to a file."

  stage "implement" kind="llm" goal_gate=true prompt="Implement the approved plan for goal: $goal with tests. The plan is in the plan stage response — do not look for a plan file."

  stage "selfci" kind="tool" command="nix develop -c selfci"

  stage "review_code" kind="llm" model="gpt-5.3-codex" provider="openai-codex" auto_status=true prompt_file=".pi/skills/attractor-typescript-code-review/SKILL.md" prompt="Review changed files for code quality. [STATUS: fail] if blocking issues else [STATUS: success]."
  stage "review_security" kind="llm" model="gpt-5.3-codex" provider="openai-codex" auto_status=true prompt_file=".pi/skills/attractor-typescript-security-review/SKILL.md" prompt="Review changed files for security. [STATUS: fail] if blocking issues else [STATUS: success]."
  stage "review_perf" kind="llm" model="gpt-5.3-codex" provider="openai-codex" auto_status=true prompt_file=".pi/skills/attractor-typescript-performance-review/SKILL.md" prompt="Review changed files for performance. [STATUS: fail] if blocking issues else [STATUS: success]."
  stage "review_tests" kind="llm" model="gpt-5.3-codex" provider="openai-codex" auto_status=true prompt_file=".pi/skills/attractor-typescript-test-review/SKILL.md" prompt="Review changed tests coverage. [STATUS: fail] if critical gaps else [STATUS: success]."

  stage "gate" kind="decision" {
    route when="outcome(\"selfci\") != \"success\" || outcome(\"review_code\") != \"success\" || outcome(\"review_security\") != \"success\" || outcome(\"review_perf\") != \"success\" || outcome(\"review_tests\") != \"success\"" to="fix"
    route when="true" to="exit"
  }

  stage "fix" kind="llm" prompt="Fix issues from CI and review findings without changing scope." {
    retry max_attempts=3 backoff="exponential"
  }

  stage "exit" kind="exit"

  transition from="plan" to="plan_review"
  transition from="plan_review" to="human_review"
  transition from="plan_revise" to="plan_review"
  transition from="implement" to="selfci"
  transition from="selfci" to="review_code" when="outcome(\"selfci\") == \"success\""
  transition from="selfci" to="fix" when="outcome(\"selfci\") != \"success\""
  transition from="review_code" to="review_security" when="outcome(\"review_code\") == \"success\""
  transition from="review_code" to="gate" when="outcome(\"review_code\") != \"success\""
  transition from="review_security" to="review_perf" when="outcome(\"review_security\") == \"success\""
  transition from="review_security" to="gate" when="outcome(\"review_security\") != \"success\""
  transition from="review_perf" to="review_tests" when="outcome(\"review_perf\") == \"success\""
  transition from="review_perf" to="gate" when="outcome(\"review_perf\") != \"success\""
  transition from="review_tests" to="gate"
  transition from="fix" to="selfci"
  transition from="gate" to="exit"
}

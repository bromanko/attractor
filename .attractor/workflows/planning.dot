digraph Planning {
    graph [
        goal="(specify with --goal)",
        label="Planning Pipeline"
    ]
    node [shape=box]

    // ── Lifecycle ──────────────────────────────────────────────
    start           [shape=Mdiamond]
    exit            [shape=Msquare]

    // ── Workspace isolation ────────────────────────────────────
    ws_create       [type="workspace.create", workspace_name="planning"]

    // ── Planning ───────────────────────────────────────────────
    plan            [
        label="Plan",
        llm_model="gpt-5.3-codex",
        llm_provider="openai-codex",
        prompt="You are working on an existing TypeScript project.\n\
Read the project structure, README, existing code, and tests to understand \
the codebase thoroughly.\n\n\
Then create a detailed implementation plan for the goal.\n\n\
Goal: $goal\n\n\
Your plan should include:\n\
1. **Summary** — A concise description of what needs to happen and why.\n\
2. **Files to change** — Which files need to be created, modified, or deleted, and why.\n\
3. **Approach** — The specific design decisions, data flow, and resolution logic.\n\
4. **Edge cases** — Boundary conditions, error handling, and failure modes to address.\n\
5. **Test cases** — Concrete test scenarios to write, covering happy path and edge cases.\n\
6. **Open questions** — Anything that needs human input or is ambiguous.\n\n\
Output the plan as a structured, numbered document with clear headings.\n\
Keep it concise and actionable — this is a planning document, not a specification."
    ]

    // ── LLM review (advisory, runs first) ──────────────────────
    plan_review     [
        label="Review plan (LLM)",
        llm_model="gpt-5.3-codex",
        llm_provider="openai-codex",
        prompt="You are a senior engineer reviewing an implementation plan.\n\n\
Review the plan from the previous stage for:\n\
1. **Completeness** — does it cover the important cases?\n\
2. **Correctness** — will the approach work with the existing codebase?\n\
3. **Risk** — are there serious edge cases or breaking changes missed?\n\
4. **Scope** — is it appropriately sized, or over/under-engineered?\n\n\
Provide your assessment as a concise list of strengths and concerns.\n\
Focus on issues that would actually block implementation, not theoretical perfection.\n\
A plan does not need to be a complete specification — it needs to be a good guide.\n\n\
If the plan is sound enough to implement, output [STATUS: success] and your summary.\n\
If there are serious gaps that would cause implementation to fail, \
output [STATUS: fail] with [FAILURE_REASON: ...] listing the critical issues only."
    ]

    // ── Human review (final authority) ─────────────────────────
    //    The human sees both the plan AND the LLM critique,
    //    and decides whether to accept, revise, or override.
    human_review    [
        shape=hexagon,
        label="Review plan + critique",
        prompt="Review the plan and the LLM critique above.\n\
You have final authority — accept the plan as-is, or send it back for revision."
    ]

    // ── Revision ───────────────────────────────────────────────
    plan_revise     [
        label="Revise plan",
        llm_model="gpt-5.3-codex",
        llm_provider="openai-codex",
        prompt="The plan needs revision based on feedback.\n\n\
Check the pipeline context for human.gate.feedback and \
plan_review.response to understand what needs to change.\n\n\
Address the feedback and output the complete revised plan.\n\
Keep it concise and actionable — avoid over-engineering \
or expanding scope beyond what was requested.",
        max_retries=1
    ]

    // ── Write plan to docs ─────────────────────────────────────
    write_plan      [
        label="Write plan document",
        llm_model="gpt-5.3-codex",
        llm_provider="openai-codex",
        prompt="The implementation plan has been approved.\n\n\
Write the final plan to a markdown file at ./docs/plans/<slug>.md where <slug> \
is a short kebab-case name derived from the goal.\n\n\
Goal: $goal\n\n\
The document should have this structure:\n\
- YAML frontmatter with: title, date (today), goal, status (approved)\n\
- The complete approved plan, well-formatted with markdown headings\n\
- A 'Decision Log' section noting any revisions made during review\n\n\
Create the ./docs/plans/ directory if it does not exist.\n\
Commit the file with the message: 'docs: add plan for <slug>'."
    ]

    // ── Merge back ─────────────────────────────────────────────
    ws_merge        [type="workspace.merge"]
    ws_cleanup      [type="workspace.cleanup"]

    // ── Flow ───────────────────────────────────────────────────
    //
    //  plan → plan_review (LLM) → human_review (sees both)
    //                                ├─ [Accept]  → write_plan → merge → exit
    //                                └─ [Revise]  → plan_revise → plan_review → ...
    //
    start        -> ws_create
    ws_create    -> plan
    plan         -> plan_review
    plan_review  -> human_review
    human_review -> write_plan   [label="Accept"]
    human_review -> plan_revise  [label="Revise"]
    plan_revise  -> plan_review

    write_plan   -> ws_merge
    ws_merge     -> ws_cleanup
    ws_cleanup   -> exit
}

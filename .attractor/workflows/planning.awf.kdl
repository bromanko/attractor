workflow "Planning" {
  version 2
  goal "(specify with --goal)"
  start "ws_create"

  stage "ws_create" kind="workspace.create" workspace_name="planning"

  stage "plan" kind="llm" model="gpt-5.3-codex" provider="openai-codex" prompt="You are working on an existing TypeScript project.\nRead the project structure, README, existing code, and tests to understand the codebase thoroughly.\n\nThen create a detailed implementation plan for the goal.\n\nGoal: $goal\n\nYour plan should include:\n1. Summary\n2. Files to change\n3. Approach\n4. Edge cases\n5. Test cases\n6. Open questions\n\nOutput a concise structured plan."

  stage "plan_review" kind="llm" model="gpt-5.3-codex" provider="openai-codex" auto_status=true prompt="You are a senior engineer reviewing an implementation plan.\n\nIf the plan is sound enough to implement, output [STATUS: success].\nIf there are serious gaps, output [STATUS: fail] with [FAILURE_REASON: ...]."

  stage "human_review" kind="human" {
    prompt "Review the plan and the LLM critique. You have final authority."
    option "accept" label="Accept" to="write_plan"
    option "revise" label="Revise" to="plan_revise"
    meta {
      review_markdown_keys "plan._full_response,plan_review._full_response"
      draft_context_key "plan._full_response"
      draft_path "docs/plans/<slug>.draft.md"
    }
  }

  stage "plan_revise" kind="llm" model="gpt-5.3-codex" provider="openai-codex" response_key_base="plan" prompt="Revise the plan based on human.gate.feedback and plan_review.response. Output the complete revised plan." {
    retry max_attempts=2 backoff="exponential"
  }

  stage "write_plan" kind="llm" model="gpt-5.3-codex" provider="openai-codex" prompt="Write the final approved plan to ./docs/plans/<slug>.md with frontmatter and decision log. Commit with message: docs: add plan for <slug>."

  stage "ws_merge" kind="workspace.merge"
  stage "ws_cleanup" kind="workspace.cleanup"
  stage "exit" kind="exit"

  transition from="ws_create" to="plan"
  transition from="plan" to="plan_review"
  transition from="plan_review" to="human_review"
  transition from="plan_revise" to="plan_review"
  transition from="write_plan" to="ws_merge"
  transition from="ws_merge" to="ws_cleanup"
  transition from="ws_cleanup" to="exit"
}

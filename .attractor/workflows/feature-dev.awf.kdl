workflow "FeatureDev" {
  version 2
  goal "(specify with --goal)"
  start "ws_create"

  stage "ws_create" kind="workspace.create" workspace_name="feature-dev"

  stage "plan" kind="llm" model="gpt-5.3-codex" provider="openai-codex" prompt="Read project context and create a concrete implementation plan for goal: $goal."

  stage "human_review" kind="human" {
    prompt "Review plan. Approve to proceed or revise."
    option "approve" label="Approve" to="plan_review"
    option "revise" label="Revise" to="plan_revise"
  }

  stage "plan_review" kind="llm" model="gpt-5.3-codex" provider="openai-codex" auto_status=true prompt="Review plan quality. Output [STATUS: success] or [STATUS: fail] with [FAILURE_REASON: ...]."

  stage "plan_gate" kind="decision" {
    route when="outcome(\"plan_review\") == \"success\"" to="implement"
    route when="true" to="plan_revise"
  }

  stage "plan_revise" kind="llm" model="gpt-5.3-codex" provider="openai-codex" prompt="Revise plan based on feedback from human.gate.feedback and plan_review.response." {
    retry max_attempts=2 backoff="exponential"
  }

  stage "implement" kind="llm" goal_gate=true prompt="Implement the approved plan for goal: $goal with tests."
  stage "selfci" kind="tool" command="CANDIDATE=$(jj log -r 'latest(heads(::@ ~ empty()))' --no-graph -T 'commit_id.short()' --limit 1) && nix develop -c selfci check --candidate $CANDIDATE"

  stage "review_code" kind="llm" model="gpt-5.3-codex" provider="openai-codex" auto_status=true prompt_file=".pi/skills/attractor-typescript-code-review/SKILL.md"
  stage "review_security" kind="llm" model="gpt-5.3-codex" provider="openai-codex" auto_status=true prompt_file=".pi/skills/attractor-typescript-security-review/SKILL.md"
  stage "review_perf" kind="llm" model="gpt-5.3-codex" provider="openai-codex" auto_status=true prompt_file=".pi/skills/attractor-typescript-performance-review/SKILL.md"
  stage "review_tests" kind="llm" model="gpt-5.3-codex" provider="openai-codex" auto_status=true prompt_file=".pi/skills/attractor-typescript-test-review/SKILL.md"

  stage "gate" kind="decision" {
    route when="outcome(\"selfci\") != \"success\" || outcome(\"review_code\") != \"success\" || outcome(\"review_security\") != \"success\" || outcome(\"review_perf\") != \"success\" || outcome(\"review_tests\") != \"success\"" to="fix"
    route when="true" to="ws_merge"
  }

  stage "fix" kind="llm" prompt="Fix issues from CI/reviews without changing scope." {
    retry max_attempts=3 backoff="exponential"
  }

  stage "ws_merge" kind="workspace.merge"
  stage "ws_cleanup" kind="workspace.cleanup"
  stage "exit" kind="exit"

  transition from="ws_create" to="plan"
  transition from="plan" to="human_review"
  transition from="plan_review" to="plan_gate"
  transition from="plan_revise" to="human_review"

  transition from="implement" to="selfci"
  transition from="selfci" to="review_code" when="outcome(\"selfci\") == \"success\""
  transition from="selfci" to="fix" when="outcome(\"selfci\") != \"success\""
  transition from="review_code" to="review_security" when="outcome(\"review_code\") == \"success\""
  transition from="review_code" to="gate" when="outcome(\"review_code\") != \"success\""
  transition from="review_security" to="review_perf" when="outcome(\"review_security\") == \"success\""
  transition from="review_security" to="gate" when="outcome(\"review_security\") != \"success\""
  transition from="review_perf" to="review_tests" when="outcome(\"review_perf\") == \"success\""
  transition from="review_perf" to="gate" when="outcome(\"review_perf\") != \"success\""
  transition from="review_tests" to="gate"

  transition from="fix" to="selfci"
  transition from="ws_merge" to="ws_cleanup"
  transition from="ws_cleanup" to="exit"
}
